<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo-512x512.png" color="#222">
  <meta name="google-site-verification" content="jZ7dJJlouQrswxytAryX3LanLNrTthfFdMUkDJzRqIU">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.keychan.xyz","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.22.0","exturl":false,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"mac"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="1. 为什么要声明式导航在 Flutter 的早期开发中，我们几乎都是通过 Navigator.push() 来完成页面跳转的。这种方式直观、易上手，但当应用体量一旦变大、业务流程变复杂，命令式导航（imperative navigation）就会开始暴露出一系列问题。">
<meta property="og:type" content="article">
<meta property="og:title" content="「Flutter系列④」路由、导航与多端协同：嵌套路由与多端差异处理">
<meta property="og:url" content="https://www.keychan.xyz/2025/10/08/033-flutter-routing-navigation-multi-terminal-collaboration/index.html">
<meta property="og:site_name" content="KeyChan&#39;s blog">
<meta property="og:description" content="1. 为什么要声明式导航在 Flutter 的早期开发中，我们几乎都是通过 Navigator.push() 来完成页面跳转的。这种方式直观、易上手，但当应用体量一旦变大、业务流程变复杂，命令式导航（imperative navigation）就会开始暴露出一系列问题。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-10-08T10:40:12.000Z">
<meta property="article:modified_time" content="2025-10-15T01:47:48.330Z">
<meta property="article:author" content="KeyChan">
<meta property="article:tag" content="Flutter">
<meta property="article:tag" content="状态管理">
<meta property="article:tag" content="路由">
<meta property="article:tag" content="模块化">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.keychan.xyz/2025/10/08/033-flutter-routing-navigation-multi-terminal-collaboration/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.keychan.xyz/2025/10/08/033-flutter-routing-navigation-multi-terminal-collaboration/","path":"2025/10/08/033-flutter-routing-navigation-multi-terminal-collaboration/","title":"「Flutter系列④」路由、导航与多端协同：嵌套路由与多端差异处理"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>「Flutter系列④」路由、导航与多端协同：嵌套路由与多端差异处理 | KeyChan's blog</title>
  







<link rel="dns-prefetch" href="https://comment.mengyajia.com">
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="KeyChan's blog" type="application/atom+xml">
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">KeyChan's blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-系列"><a href="/series/" rel="section"><i class="fa fa-list-ol fa-fw"></i>系列</a></li><li class="menu-item menu-item-随想"><a href="/think/" rel="section"><i class="fa fa-lightbulb fa-fw"></i>随想</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-rss"><a href="/atom.xml" rel="section"><i class="fa fa-rss fa-fw"></i>RSS</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%A3%B0%E6%98%8E%E5%BC%8F%E5%AF%BC%E8%88%AA"><span class="nav-text">1. 为什么要声明式导航</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-Navigator-1-0-%E7%9A%84%E5%B1%80%E9%99%90"><span class="nav-text">1.1 Navigator 1.0 的局限</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-1-%E5%BC%BA%E4%BE%9D%E8%B5%96%E4%B8%8A%E4%B8%8B%E6%96%87%EF%BC%8C%E9%9A%BE%E4%BB%A5%E5%85%A8%E5%B1%80%E6%8E%A7%E5%88%B6"><span class="nav-text">1.1.1 强依赖上下文，难以全局控制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-2-%E5%AF%BC%E8%88%AA%E7%8A%B6%E6%80%81%E4%B8%8E%E5%BA%94%E7%94%A8%E7%8A%B6%E6%80%81%E8%84%B1%E8%8A%82"><span class="nav-text">1.1.2 导航状态与应用状态脱节</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-3-%E5%A4%9A%E7%AB%AF%E3%80%81%E5%A4%9A%E5%85%A5%E5%8F%A3%E5%9C%BA%E6%99%AF%E5%87%A0%E4%B9%8E%E6%97%A0%E6%B3%95%E5%BA%94%E5%AF%B9"><span class="nav-text">1.1.3 多端、多入口场景几乎无法应对</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E5%A3%B0%E6%98%8E%E5%BC%8F%E5%AF%BC%E8%88%AA%EF%BC%9A%E2%80%9C%E8%B7%AF%E7%94%B1%E2%80%9D%E7%8A%B6%E6%80%81"><span class="nav-text">1.2 声明式导航：“路由”状态</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-1-%E7%8A%B6%E6%80%81%E9%A9%B1%E5%8A%A8-UI"><span class="nav-text">1.2.1 状态驱动 UI</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-2-URL-%E2%86%94-%E7%8A%B6%E6%80%81%E5%90%8C%E6%AD%A5"><span class="nav-text">1.2.2 URL ↔ 状态同步</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-3-%E5%8F%AF%E9%A2%84%E6%B5%8B%E3%80%81%E5%8F%AF%E6%B5%8B%E8%AF%95%E7%9A%84%E5%AF%BC%E8%88%AA%E8%A1%8C%E4%B8%BA"><span class="nav-text">1.2.3 可预测、可测试的导航行为</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E5%A3%B0%E6%98%8E%E5%BC%8F%E5%AF%BC%E8%88%AA%E4%BC%98%E5%8A%BF"><span class="nav-text">1.3 声明式导航优势</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Navigator-2-0-%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3"><span class="nav-text">2. Navigator 2.0 核心机制详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E4%BB%8E-push-pop-%E5%88%B0%E7%8A%B6%E6%80%81%E9%A9%B1%E5%8A%A8%E6%A0%88"><span class="nav-text">2.1 从 push&#x2F;pop 到状态驱动栈</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-Navigator-2-0-%E7%9A%84%E4%B8%89%E4%BB%B6%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6"><span class="nav-text">2.2 Navigator 2.0 的三件核心组件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%EF%BC%9A%E4%BB%8E-URL-%E5%88%B0%E9%A1%B5%E9%9D%A2"><span class="nav-text">2.3 生命周期：从 URL 到页面</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-%E6%9C%80%E5%B0%8F%E5%8F%AF%E8%BF%90%E8%A1%8C%E9%AA%A8%E6%9E%B6"><span class="nav-text">2.4 最小可运行骨架</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-%E6%95%B0%E6%8D%AE%E6%B5%81%E5%9B%BE%E7%A4%BA"><span class="nav-text">2.5 数据流图示</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-%E4%B8%BA%E4%BB%80%E4%B9%88%E6%98%AF%E2%80%9C%E9%87%8D%E5%BB%BA%E9%A1%B5%E9%9D%A2%E6%A0%88%E2%80%9D%EF%BC%8C%E8%80%8C%E4%B8%8D%E6%98%AF-push-pop"><span class="nav-text">2.6 为什么是“重建页面栈”，而不是 push&#x2F;pop</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%A4%8D%E6%9D%82%E5%AF%BC%E8%88%AA%E4%B8%8E%E7%8A%B6%E6%80%81%E5%90%8C%E6%AD%A5"><span class="nav-text">3. 复杂导航与状态同步</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E5%A4%9A%E5%AF%BC%E8%88%AA%E6%A0%88%E5%9C%BA%E6%99%AF%EF%BC%9A%E5%BA%95%E9%83%A8-Tab"><span class="nav-text">3.1 多导航栈场景：底部 Tab</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-1-%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="nav-text">3.1.1 代码示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-2-%E7%90%86%E8%A7%A3%E8%A6%81%E7%82%B9"><span class="nav-text">3.1.2 理解要点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E5%B5%8C%E5%A5%97%E8%B7%AF%E7%94%B1%EF%BC%9A%E7%88%B6%E5%B1%82%E6%A1%86%E6%9E%B6-%E5%AD%90%E5%8C%BA%E5%9F%9F%E6%8E%A7%E5%88%B6"><span class="nav-text">3.2 嵌套路由：父层框架 + 子区域控制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-1-%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="nav-text">3.2.1 代码示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-%E6%A8%A1%E6%80%81%E4%B8%8E%E5%85%A8%E5%B1%8F%E9%A1%B5%E9%9D%A2"><span class="nav-text">3.3 模态与全屏页面</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-%E5%8F%82%E6%95%B0%E4%B8%8E%E8%BF%94%E5%9B%9E%E5%80%BC%EF%BC%9A%E7%94%A8%E7%8A%B6%E6%80%81%E8%80%8C%E9%9D%9E%E5%9B%9E%E8%B0%83"><span class="nav-text">3.4 参数与返回值：用状态而非回调</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1%E6%B3%A8%E5%86%8C%E4%B8%8E%E6%A8%A1%E5%9D%97%E7%83%AD%E6%9B%B4%E6%96%B0"><span class="nav-text">3.5 动态路由注册与模块热更新</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E9%89%B4%E6%9D%83%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%AE%88%E5%8D%AB"><span class="nav-text">4. 鉴权与路由守卫</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E8%B7%AF%E7%94%B1%E5%AE%88%E5%8D%AB"><span class="nav-text">4.1 为什么需要路由守卫</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E5%A3%B0%E6%98%8E%E5%BC%8F%E5%AF%BC%E8%88%AA%E4%B8%8B%E7%9A%84%E7%99%BB%E5%BD%95%E5%AE%88%E5%8D%AB%E7%AD%96%E7%95%A5"><span class="nav-text">4.2 声明式导航下的登录守卫策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-%E5%85%B8%E5%9E%8B%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B"><span class="nav-text">4.3 典型登录流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-%E7%94%A8%E6%88%B7%E4%BD%93%E9%AA%8C%E4%BC%98%E5%8C%96"><span class="nav-text">4.4 用户体验优化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E5%A4%9A%E7%AB%AF%E5%AF%BC%E8%88%AA%E9%80%82%E9%85%8D"><span class="nav-text">5. 多端导航适配</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-Web-%E7%AB%AF%E5%B7%AE%E5%BC%82%E4%B8%8E%E9%80%82%E9%85%8D"><span class="nav-text">5.1 Web 端差异与适配</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-Desktop-%E7%AB%AF%E5%B7%AE%E5%BC%82%E4%B8%8E%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC"><span class="nav-text">5.2 Desktop 端差异与事件监听</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-%E7%A7%BB%E5%8A%A8%E7%AB%AF%E4%B8%8E%E5%A4%9A%E7%AB%AF%E7%BB%9F%E4%B8%80%E5%B0%81%E8%A3%85"><span class="nav-text">5.3 移动端与多端统一封装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-SEO-%E4%B8%8E%E8%B7%AF%E5%BE%84%E5%8F%AF%E8%AF%BB%E6%80%A7%EF%BC%88Web-%E4%B8%93%E5%B1%9E%EF%BC%89"><span class="nav-text">5.4 SEO 与路径可读性（Web 专属）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E8%B0%83%E8%AF%95%E3%80%81%E6%B5%8B%E8%AF%95%E4%B8%8E%E5%B7%A5%E7%A8%8B%E6%A8%A1%E6%9D%BF"><span class="nav-text">6. 调试、测试与工程模板</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7"><span class="nav-text">6.1 调试技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-1-RouterDelegate-%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-text">6.1.1 RouterDelegate 的生命周期</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-2-Flutter-DevTools-%E6%9F%A5%E7%9C%8B-rebuild"><span class="nav-text">6.1.2 Flutter DevTools 查看 rebuild</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-3-%E5%B8%B8%E8%A7%81-Bug-%E4%B8%8E%E6%8E%92%E6%9F%A5"><span class="nav-text">6.1.3 常见 Bug 与排查</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-%E6%B5%8B%E8%AF%95%E7%AD%96%E7%95%A5"><span class="nav-text">6.2 测试策略</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-2-1-%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%EF%BC%9A%E9%AA%8C%E8%AF%81-RouteParser-%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA"><span class="nav-text">6.2.1 单元测试：验证 RouteParser 输入输出</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-2-2-%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95%EF%BC%9A%E6%A8%A1%E6%8B%9F%E7%94%A8%E6%88%B7%E5%AF%BC%E8%88%AA%E8%A1%8C%E4%B8%BA"><span class="nav-text">6.2.2 集成测试：模拟用户导航行为</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-%E5%B7%A5%E7%A8%8B%E6%A8%A1%E6%9D%BF%EF%BC%9A%E4%BB%8E-Demo-%E5%88%B0%E5%8F%AF%E7%BB%B4%E6%8A%A4%E6%9E%B6%E6%9E%84"><span class="nav-text">6.3 工程模板：从 Demo 到可维护架构</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%E6%80%BB%E7%BB%93"><span class="nav-text">7. 总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-%E5%A4%87%E6%B3%A8"><span class="nav-text">8. 备注</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="KeyChan"
      src="/images/key_avatar.png">
  <p class="site-author-name" itemprop="name">KeyChan</p>
  <div class="site-description" itemprop="description">全干工程师</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">40</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">71</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/keychankc" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;keychankc" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:kckeychan@gmail.com" title="E-Mail → mailto:kckeychan@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://x.com/keychankc" title="Twitter → https:&#x2F;&#x2F;x.com&#x2F;keychankc" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.keychan.xyz/2025/10/08/033-flutter-routing-navigation-multi-terminal-collaboration/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/key_avatar.png">
      <meta itemprop="name" content="KeyChan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="KeyChan's blog">
      <meta itemprop="description" content="全干工程师">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="「Flutter系列④」路由、导航与多端协同：嵌套路由与多端差异处理 | KeyChan's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          「Flutter系列④」路由、导航与多端协同：嵌套路由与多端差异处理
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-10-08 18:40:12" itemprop="dateCreated datePublished" datetime="2025-10-08T18:40:12+08:00">2025-10-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-10-15 09:47:48" itemprop="dateModified" datetime="2025-10-15T09:47:48+08:00">2025-10-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%B7%A8%E5%B9%B3%E5%8F%B0%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">跨平台框架</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2025/10/08/033-flutter-routing-navigation-multi-terminal-collaboration/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2025/10/08/033-flutter-routing-navigation-multi-terminal-collaboration/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>7.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>26 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="1-为什么要声明式导航"><a href="#1-为什么要声明式导航" class="headerlink" title="1. 为什么要声明式导航"></a>1. 为什么要声明式导航</h2><p>在 Flutter 的早期开发中，我们几乎都是通过 <code>Navigator.push()</code> 来完成页面跳转的。<br>这种方式直观、易上手，但当应用体量一旦变大、业务流程变复杂，命令式导航（imperative navigation）就会开始暴露出一系列问题。</p>
<span id="more"></span>
<h3 id="1-1-Navigator-1-0-的局限"><a href="#1-1-Navigator-1-0-的局限" class="headerlink" title="1.1 Navigator 1.0 的局限"></a>1.1 Navigator 1.0 的局限</h3><h4 id="1-1-1-强依赖上下文，难以全局控制"><a href="#1-1-1-强依赖上下文，难以全局控制" class="headerlink" title="1.1.1 强依赖上下文，难以全局控制"></a>1.1.1 强依赖上下文，难以全局控制</h4><p>最常见的写法是这样的：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Navigator.push(context, MaterialPageRoute(builder: (_) =&gt; DetailPage()));</span><br></pre></td></tr></table></figure>
<p>这行代码看似简单，但其实隐藏了两个痛点：</p>
<ul>
<li><strong>需要拿到 context 才能跳转</strong> —— 在很多场景下（比如 ViewModel、全局控制器），根本拿不到合适的 BuildContext；</li>
<li><strong>无法全局感知当前导航状态</strong> —— 页面栈是 Navigator 内部私有的，外部无法直接读取或恢复。</li>
</ul>
<p>换句话说，我们虽然可以命令它“跳转”，但看不见它“现在在哪”。当业务线越来越多（例如：登录 → 支付 → 成功页 → 个人中心），这种盲目的导航就会让状态变得越来越混乱。</p>
<h4 id="1-1-2-导航状态与应用状态脱节"><a href="#1-1-2-导航状态与应用状态脱节" class="headerlink" title="1.1.2 导航状态与应用状态脱节"></a>1.1.2 导航状态与应用状态脱节</h4><p>在命令式模型中，页面栈是独立存在的。即使应用的业务状态已经变化（例如用户已登录），你仍需要手动去 pop 到对应页面或重新 push 正确的目标页。</p>
<p>这意味着 <strong>UI 不再由状态驱动，而是由命令驱动</strong>。当页面层级多、异步逻辑复杂时，就很容易出现“UI 状态和业务状态不同步”的情况。</p>
<h4 id="1-1-3-多端、多入口场景几乎无法应对"><a href="#1-1-3-多端、多入口场景几乎无法应对" class="headerlink" title="1.1.3 多端、多入口场景几乎无法应对"></a>1.1.3 多端、多入口场景几乎无法应对</h4><p>假设我们的应用要同时支持：</p>
<ul>
<li><strong>Web 深度链接</strong>（用户输入 &#x2F;profile&#x2F;123 打开用户详情）</li>
<li><strong>桌面端多窗口</strong>（每个窗口展示不同模块）</li>
<li><strong>App 启动参数唤起</strong>（从推送直接进入订单页）</li>
</ul>
<p>命令式导航就很难处理这些外部路径。我们只能在 onGenerateRoute 里写大量条件判断，或在全局单例中手动解析 URL 再跳转，这样既脆弱又难维护。</p>
<h3 id="1-2-声明式导航：“路由”状态"><a href="#1-2-声明式导航：“路由”状态" class="headerlink" title="1.2 声明式导航：“路由”状态"></a>1.2 声明式导航：“路由”状态</h3><p>为了解决这些问题，Flutter 从 Navigator 2.0 开始引入了 <strong>声明式（Declarative）导航模型</strong>。</p>
<p>它的核心思想是：</p>
<blockquote>
<p>“我们不再命令 Navigator 去做什么，而是描述当前应用<strong>应该是什么状态</strong>。”</p>
</blockquote>
<p>换句话说，页面不再是命令堆叠的结果，而是状态声明的反映。当状态变化时，框架会自动根据新状态重建页面栈。</p>
<h4 id="1-2-1-状态驱动-UI"><a href="#1-2-1-状态驱动-UI" class="headerlink" title="1.2.1 状态驱动 UI"></a>1.2.1 状态驱动 UI</h4><p>在声明式模式下，我们只需要告诉系统：“现在用户处于登录状态” 或 “当前选中的文章 ID 是 42”，RouterDelegate 就会根据这个状态渲染出对应页面。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Navigator 1.0</span></span><br><span class="line">Navigator.push(context, MaterialPageRoute(builder: (_) =&gt; DetailPage()));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Navigator 2.0</span></span><br><span class="line">routerDelegate.setNewRoutePath(AppRoute.detail());</span><br></pre></td></tr></table></figure>
<p>区别在于，前者是命令式地“执行一次跳转”，后者是声明式地“更新路由状态”，框架自动重建页面栈。</p>
<h4 id="1-2-2-URL-↔-状态同步"><a href="#1-2-2-URL-↔-状态同步" class="headerlink" title="1.2.2 URL ↔ 状态同步"></a>1.2.2 URL ↔ 状态同步</h4><p>在 Navigator 2.0 中，<strong>路由状态与 URL 可以完全对齐</strong>。<br>RouteInformationParser 会解析浏览器地址栏或系统传入的路径，生成对应的内部状态对象。<br>RouterDelegate 再根据这个状态，重建页面栈。</p>
<p>这样一来：</p>
<ul>
<li>在 Web 端刷新不会丢失页面；</li>
<li>点击浏览器返回键会真正回到上一个状态；</li>
<li>甚至可以直接复制 URL 给别人，打开时显示完全相同的内容。</li>
</ul>
<h4 id="1-2-3-可预测、可测试的导航行为"><a href="#1-2-3-可预测、可测试的导航行为" class="headerlink" title="1.2.3 可预测、可测试的导航行为"></a>1.2.3 可预测、可测试的导航行为</h4><p>由于页面完全由状态描述构建，因此我们可以：</p>
<ul>
<li>直接通过状态判断应用当前“在哪一页”；</li>
<li>通过修改状态驱动跳转，无需操作 Navigator；</li>
<li>编写单元测试来验证“某状态下是否渲染了正确页面”。</li>
</ul>
<p>这让导航逻辑不再是一个黑盒，而是可以推理、可验证的系统。</p>
<h3 id="1-3-声明式导航优势"><a href="#1-3-声明式导航优势" class="headerlink" title="1.3 声明式导航优势"></a>1.3 声明式导航优势</h3><p>在中小型应用中，命令式导航仍然足够简单直接。但一旦进入大型工程，声明式导航带来会带来很多好处：</p>
<table>
<thead>
<tr>
<th><strong>场景</strong></th>
<th><strong>1.0 的困难</strong></th>
<th><strong>2.0 的优势</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>多模块应用</strong></td>
<td>各模块 Navigator 独立，状态不同步</td>
<td>可用统一 AppState 控制全局路由</td>
</tr>
<tr>
<td><strong>登录&#x2F;支付流程</strong></td>
<td>路径跳转多、逻辑分支复杂</td>
<td>路由栈可通过状态直接定义</td>
</tr>
<tr>
<td><strong>Web &#x2F; 桌面端</strong></td>
<td>无法同步 URL 或窗口</td>
<td>URL 与状态天然绑定</td>
</tr>
<tr>
<td><strong>测试与恢复</strong></td>
<td>无法预设页面状态</td>
<td>可直接恢复路由配置</td>
</tr>
</tbody></table>
<p>我们可以把 Navigator 2.0 看作是 Flutter 导航体系的“架构级升级”：从“命令驱动的动作系统” → “状态驱动的声明系统”。</p>
<table>
<thead>
<tr>
<th><strong>命令式导航</strong></th>
<th><strong>声明式导航</strong></th>
</tr>
</thead>
<tbody><tr>
<td>点击按钮 → push() → 进入页面</td>
<td>改变状态 → RouterDelegate rebuild → 页面更新</td>
</tr>
<tr>
<td>左边是“指令驱动”的思路；右边是“状态驱动”的思路。</td>
<td></td>
</tr>
<tr>
<td>在小项目中，左边简单够用；但在多入口、多端协同的项目中，右边能保持一致性与可控性。</td>
<td></td>
</tr>
</tbody></table>
<h2 id="2-Navigator-2-0-核心机制详解"><a href="#2-Navigator-2-0-核心机制详解" class="headerlink" title="2. Navigator 2.0 核心机制详解"></a>2. Navigator 2.0 核心机制详解</h2><h3 id="2-1-从-push-pop-到状态驱动栈"><a href="#2-1-从-push-pop-到状态驱动栈" class="headerlink" title="2.1 从 push&#x2F;pop 到状态驱动栈"></a>2.1 从 push&#x2F;pop 到状态驱动栈</h3><p>上一章我们谈到“声明式导航”是以<strong>状态驱动页面栈</strong>。这一章，我们正式进入 Navigator 2.0 的核心机制——<br>理解 <strong>它是如何将状态 → 页面栈 → UI 渲染</strong> 串联起来的。</p>
<p>Navigator 2.0 的设计目标是：</p>
<blockquote>
<p>不再手动操作页面栈，而是由一个可追踪的状态系统来决定“页面栈该长什么样”。</p>
</blockquote>
<h3 id="2-2-Navigator-2-0-的三件核心组件"><a href="#2-2-Navigator-2-0-的三件核心组件" class="headerlink" title="2.2 Navigator 2.0 的三件核心组件"></a>2.2 Navigator 2.0 的三件核心组件</h3><p>Navigator 2.0 的底层是一个解耦的三层结构：</p>
<table>
<thead>
<tr>
<th><strong>组件</strong></th>
<th><strong>职责</strong></th>
<th><strong>类比</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>RouteInformationParser</strong></td>
<td>把 URL 解析为内部路由状态</td>
<td>导航“翻译官”</td>
</tr>
<tr>
<td><strong>RouterDelegate</strong></td>
<td>根据当前状态构建页面栈</td>
<td>导航“导演”</td>
</tr>
<tr>
<td><strong>BackButtonDispatcher</strong></td>
<td>管理系统返回行为</td>
<td>导航“交通警”</td>
</tr>
</tbody></table>
<p>三者构成一条完整的数据流：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">URL → RouteInformationParser → 应用状态 → RouterDelegate → Page 栈 → Navigator 渲染</span><br></pre></td></tr></table></figure>
<p>这条链路保证：</p>
<ul>
<li>用户输入 URL → 应用能还原对应页面；</li>
<li>应用状态改变 → URL 实时同步；</li>
<li>用户点击返回 → 页面状态与 URL 一致。</li>
</ul>
<h3 id="2-3-生命周期：从-URL-到页面"><a href="#2-3-生命周期：从-URL-到页面" class="headerlink" title="2.3 生命周期：从 URL 到页面"></a>2.3 生命周期：从 URL 到页面</h3><p>整个导航生命周期大致如下：</p>
<ol>
<li><strong>RouteInformationParser</strong>：接收系统的 URL（如 &#x2F;detail&#x2F;42），解析为内部状态对象（如 AppRoutePath.detail(id: 42)）。</li>
<li><strong>RouterDelegate</strong>：根据当前状态，重建 Page 列表，返回一个新的页面栈给 Navigator。</li>
<li><strong>Navigator</strong>：渲染这些 Page 对应的 UI，监听返回事件（onPopPage）。</li>
<li><strong>BackButtonDispatcher</strong>：当用户按下返回键或浏览器后退时，调用 RouterDelegate → 更新状态 → 同步 URL。</li>
</ol>
<blockquote>
<p>Navigator 2.0 并不“增删页面”，而是“根据状态重建页面栈”。</p>
</blockquote>
<h3 id="2-4-最小可运行骨架"><a href="#2-4-最小可运行骨架" class="headerlink" title="2.4 最小可运行骨架"></a>2.4 最小可运行骨架</h3><p>一个典型的 Navigator 2.0 实现只需三个类：RoutePath、RouteParser、RouterDelegate。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppRoutePath</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String?</span> id;</span><br><span class="line">  AppRoutePath.home() : id = <span class="keyword">null</span>;</span><br><span class="line">  AppRoutePath.detail(<span class="keyword">this</span>.id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1️⃣ RouteInformationParser：解析 URL</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppRouteParser</span> <span class="keyword">extends</span> <span class="title">RouteInformationParser</span>&lt;<span class="title">AppRoutePath</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//  URL → 状态</span></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Future&lt;AppRoutePath&gt; parseRouteInformation(RouteInformation info) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> uri = <span class="built_in">Uri</span>.parse(info.location ?? <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (uri.pathSegments.isEmpty) <span class="keyword">return</span> AppRoutePath.home();</span><br><span class="line">    <span class="keyword">return</span> AppRoutePath.detail(uri.pathSegments.last);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2️⃣ RouterDelegate：根据状态构建页面栈</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppRouterDelegate</span> <span class="keyword">extends</span> <span class="title">RouterDelegate</span>&lt;<span class="title">AppRoutePath</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="title">with</span> <span class="title">ChangeNotifier</span>, <span class="title">PopNavigatorRouterDelegateMixin</span>&lt;<span class="title">AppRoutePath</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> GlobalKey&lt;NavigatorState&gt; navigatorKey = GlobalKey();</span><br><span class="line">  AppRoutePath _path = AppRoutePath.home();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据状态生成页面栈</span></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) =&gt; Navigator(</span><br><span class="line">        key: navigatorKey,</span><br><span class="line">        pages: [</span><br><span class="line">          MaterialPage(child: HomePage()),</span><br><span class="line">          <span class="keyword">if</span> (_path.id != <span class="keyword">null</span>)</span><br><span class="line">            MaterialPage(child: DetailPage(id: _path.id!)),</span><br><span class="line">        ],</span><br><span class="line">        onPopPage: (route, result) &#123;</span><br><span class="line">          _path = AppRoutePath.home();</span><br><span class="line">          notifyListeners();</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 外部状态变更时更新内部</span></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Future&lt;<span class="keyword">void</span>&gt; setNewRoutePath(AppRoutePath configuration) <span class="keyword">async</span> &#123;</span><br><span class="line">    _path = configuration;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-5-数据流图示"><a href="#2-5-数据流图示" class="headerlink" title="2.5 数据流图示"></a>2.5 数据流图示</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[URL]</span><br><span class="line">   ↓</span><br><span class="line">[RouteInformationParser]</span><br><span class="line">   ↓</span><br><span class="line">[RouterDelegate]  ← 状态变化通知</span><br><span class="line">   ↓</span><br><span class="line">[Navigator]</span><br><span class="line">   ↑</span><br><span class="line">[BackButtonDispatcher]</span><br></pre></td></tr></table></figure>

<p>上图的重点是<strong>双向同步</strong>：URL 改变 → 页面重建；页面返回 → URL 更新</p>
<h3 id="2-6-为什么是“重建页面栈”，而不是-push-pop"><a href="#2-6-为什么是“重建页面栈”，而不是-push-pop" class="headerlink" title="2.6 为什么是“重建页面栈”，而不是 push&#x2F;pop"></a>2.6 为什么是“重建页面栈”，而不是 push&#x2F;pop</h3><p>在 Navigator 2.0 中，RouterDelegate.build() 每次都返回一个新的页面栈（<code>List&lt;Page&gt;</code>），看似“重建”，实则 Flutter 只会根据差异更新。</p>
<p>这种声明式机制让导航变得：</p>
<ul>
<li><strong>确定性更强</strong>（页面完全由状态决定）</li>
<li><strong>调试更方便</strong>（状态可追踪）</li>
<li><strong>多端更一致</strong>（URL、窗口、返回行为统一）</li>
</ul>
<p>这也是它支持 Web 与桌面端的关键。</p>
<h2 id="3-复杂导航与状态同步"><a href="#3-复杂导航与状态同步" class="headerlink" title="3. 复杂导航与状态同步"></a>3. 复杂导航与状态同步</h2><p>当应用从单页扩展到多页面、多流程、多模块后，导航系统的复杂度会呈指数级上升。在命令式（Navigator 1.0）体系下，开发者常常需要在多个地方 push()、pop()、popUntil()，代码不仅难以维护，还难以追踪页面状态。</p>
<p>而在 Navigator 2.0 的声明式模型中，我们可以通过<strong>状态同步 + 多层级 Navigator</strong> 来管理这些复杂交互。b本章将聚焦于实际工程中最常见的几种复杂场景。</p>
<h3 id="3-1-多导航栈场景：底部-Tab"><a href="#3-1-多导航栈场景：底部-Tab" class="headerlink" title="3.1 多导航栈场景：底部 Tab"></a>3.1 多导航栈场景：底部 Tab</h3><p>想象一个典型的多 Tab 应用：</p>
<ul>
<li>首页（Feed）</li>
<li>消息（Message）</li>
<li>我的（Profile）</li>
</ul>
<p>用户在 “Feed → Detail → Back” 后，再切到 “消息 → 对话 → 返回”，如果返回 Feed tab，希望还能回到刚才浏览的那篇内容，而不是重新进入首页。这时就需要：<strong>每个 tab 独立维护自己的 Navigator 栈</strong>。</p>
<h4 id="3-1-1-代码示例"><a href="#3-1-1-代码示例" class="headerlink" title="3.1.1 代码示例"></a>3.1.1 代码示例</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;  </span><br><span class="line">  <span class="keyword">const</span> MyApp(&#123;<span class="keyword">super</span>.key&#125;);  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@override</span>  </span><br><span class="line">  Widget build(BuildContext context) &#123;  </span><br><span class="line">    <span class="keyword">return</span> MaterialApp(  </span><br><span class="line">      title: <span class="string">&#x27;Multi Navigator Demo&#x27;</span>,  </span><br><span class="line">      home: <span class="keyword">const</span> MainScaffold(),  </span><br><span class="line">    );  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/// <span class="language-markdown">--- TabNavigator：每个 tab 都维护独立的 Navigator 栈 ---</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TabNavigator</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;  </span><br><span class="line">  <span class="keyword">final</span> GlobalKey&lt;NavigatorState&gt; navigatorKey;  </span><br><span class="line">  <span class="keyword">final</span> Widget child;  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> TabNavigator(&#123;  </span><br><span class="line">    <span class="keyword">super</span>.key,  </span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">this</span>.navigatorKey,  </span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">this</span>.child,  </span><br><span class="line">  &#125;);  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@override</span>  </span><br><span class="line">  Widget build(BuildContext context) &#123;  </span><br><span class="line">    <span class="keyword">return</span> Navigator(  </span><br><span class="line">      key: navigatorKey,  </span><br><span class="line">      <span class="comment">// ✅ 新写法：使用 onDidRemovePage 替代 onPopPage      </span></span><br><span class="line">      onDidRemovePage: (page) &#123;  </span><br><span class="line">        debugPrint(<span class="string">&#x27;Page removed: <span class="subst">$&#123;page.name&#125;</span>&#x27;</span>);  </span><br><span class="line">      &#125;,  </span><br><span class="line">      pages: [  </span><br><span class="line">        MaterialPage(child: child),  </span><br><span class="line">      ],  </span><br><span class="line">    );  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainScaffold</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;  </span><br><span class="line">  <span class="keyword">const</span> MainScaffold(&#123;<span class="keyword">super</span>.key&#125;);  </span><br><span class="line">  <span class="meta">@override</span>  </span><br><span class="line">  State&lt;MainScaffold&gt; createState() =&gt; _MainScaffoldState();  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_MainScaffoldState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">MainScaffold</span>&gt; </span>&#123;  </span><br><span class="line">  <span class="built_in">int</span> currentIndex = <span class="number">0</span>;  </span><br><span class="line">  <span class="keyword">final</span> navigatorKeys = [  </span><br><span class="line">    GlobalKey&lt;NavigatorState&gt;(),  </span><br><span class="line">    GlobalKey&lt;NavigatorState&gt;(),  </span><br><span class="line">    GlobalKey&lt;NavigatorState&gt;(),  </span><br><span class="line">  ];  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@override</span>  </span><br><span class="line">  Widget build(BuildContext context) &#123;  </span><br><span class="line">    <span class="keyword">return</span> Scaffold(  </span><br><span class="line">      body: IndexedStack(  </span><br><span class="line">        index: currentIndex,  </span><br><span class="line">        children: [  </span><br><span class="line">          TabNavigator(navigatorKey: navigatorKeys[<span class="number">0</span>], child: FeedPage()),  </span><br><span class="line">          TabNavigator(navigatorKey: navigatorKeys[<span class="number">1</span>], child: MessagePage()),  </span><br><span class="line">          TabNavigator(navigatorKey: navigatorKeys[<span class="number">2</span>], child: ProfilePage()),  </span><br><span class="line">        ],  </span><br><span class="line">      ),  </span><br><span class="line">      bottomNavigationBar: BottomNavigationBar(  </span><br><span class="line">        currentIndex: currentIndex,  </span><br><span class="line">        onTap: (i) =&gt; setState(() =&gt; currentIndex = i),  </span><br><span class="line">        items: <span class="keyword">const</span> [  </span><br><span class="line">          BottomNavigationBarItem(icon: Icon(Icons.home), label: <span class="string">&#x27;Feed&#x27;</span>),  </span><br><span class="line">          BottomNavigationBarItem(icon: Icon(Icons.message), label: <span class="string">&#x27;Msg&#x27;</span>),  </span><br><span class="line">          BottomNavigationBarItem(icon: Icon(Icons.person), label: <span class="string">&#x27;Me&#x27;</span>),  </span><br><span class="line">        ],  </span><br><span class="line">      ),  </span><br><span class="line">    );  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-1-2-理解要点"><a href="#3-1-2-理解要点" class="headerlink" title="3.1.2 理解要点"></a>3.1.2 理解要点</h4><p>每个 tab 是一个独立的 Navigator；IndexedStack 保留了所有 tab 的状态；用户切换 tab 时，不会丢失导航历史。</p>
<h3 id="3-2-嵌套路由：父层框架-子区域控制"><a href="#3-2-嵌套路由：父层框架-子区域控制" class="headerlink" title="3.2 嵌套路由：父层框架 + 子区域控制"></a>3.2 嵌套路由：父层框架 + 子区域控制</h3><p>一般应用还会有“主框架 + 内容区”两层导航结构。例如：</p>
<ul>
<li>外层：主导航（底部栏、Drawer）</li>
<li>内层：具体模块（如某个业务的多层子页面）</li>
</ul>
<p>在 Navigator 2.0 中，可以将 RouterDelegate 层层嵌套：<strong>父 RouterDelegate 管整体状态，子 RouterDelegate 只负责自己区域的页面栈。</strong></p>
<h4 id="3-2-1-代码示例"><a href="#3-2-1-代码示例" class="headerlink" title="3.2.1 代码示例"></a>3.2.1 代码示例</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="language-markdown">整个应用的入口，使用 Router API 构建声明式导航</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> MyApp(&#123;<span class="keyword">super</span>.key&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> MaterialApp.router(</span><br><span class="line">      <span class="comment">// RouterDelegate 负责“当前显示什么页面”</span></span><br><span class="line">      routerDelegate: HomeRouter(),</span><br><span class="line"></span><br><span class="line">      <span class="comment">// RouteInformationParser 负责“从 URL → 解析出业务路径对象（HomePath）”</span></span><br><span class="line">      routeInformationParser: HomeRouteParser(),</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 系统返回键（Android）事件分发器</span></span><br><span class="line">      backButtonDispatcher: RootBackButtonDispatcher(),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">路径模型对象：描述当前的业务状态（是否进入详情页）</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomePath</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String?</span> id;</span><br><span class="line">  <span class="keyword">const</span> HomePath(&#123;<span class="keyword">this</span>.id&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">URL 与 HomePath 的双向映射器</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">parseRouteInformation：URL → HomePath</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">restoreRouteInformation：HomePath → URL</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeRouteParser</span> <span class="keyword">extends</span> <span class="title">RouteInformationParser</span>&lt;<span class="title">HomePath</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Future&lt;HomePath&gt; parseRouteInformation(RouteInformation routeInformation) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> uri = routeInformation.uri; <span class="comment">// Flutter 3.8+ 推荐使用 uri 属性</span></span><br><span class="line">    <span class="keyword">if</span> (uri.pathSegments.isEmpty) <span class="keyword">return</span> <span class="keyword">const</span> HomePath(); <span class="comment">// 根路径：Feed 列表页</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 匹配形如 /detail/xxx 的路径</span></span><br><span class="line">    <span class="keyword">if</span> (uri.pathSegments.length == <span class="number">2</span> &amp;&amp; uri.pathSegments.first == <span class="string">&#x27;detail&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> HomePath(id: uri.pathSegments[<span class="number">1</span>]); <span class="comment">// id = xxx</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">const</span> HomePath();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  RouteInformation restoreRouteInformation(HomePath configuration) &#123;</span><br><span class="line">    <span class="comment">// 将 HomePath 反向转换为 URL</span></span><br><span class="line">    <span class="keyword">if</span> (configuration.id != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> RouteInformation(uri: <span class="built_in">Uri</span>(path: <span class="string">&#x27;/detail/<span class="subst">$&#123;configuration.id&#125;</span>&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> RouteInformation(uri: <span class="built_in">Uri</span>(path: <span class="string">&#x27;/&#x27;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">RouterDelegate 是整个声明式导航的核心：它根据“状态”构建页面栈（Navigator.pages）</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeRouter</span> <span class="keyword">extends</span> <span class="title">RouterDelegate</span>&lt;<span class="title">HomePath</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="title">with</span> <span class="title">ChangeNotifier</span>, <span class="title">PopNavigatorRouterDelegateMixin</span>&lt;<span class="title">HomePath</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">final</span> GlobalKey&lt;NavigatorState&gt; navigatorKey = GlobalKey();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">bool</span> showDetail = <span class="keyword">false</span>; <span class="comment">// 是否展示详情页</span></span><br><span class="line">  <span class="built_in">String?</span> selectedId; <span class="comment">// 当前选中的 item ID</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Navigator(</span><br><span class="line">      key: navigatorKey,</span><br><span class="line">      <span class="comment">/// <span class="language-markdown">声明式页面栈：根据状态决定有哪些页面</span></span></span><br><span class="line">      pages: [</span><br><span class="line">        <span class="comment">// 主列表页（FeedPage）</span></span><br><span class="line">        MaterialPage(</span><br><span class="line">          key: <span class="keyword">const</span> ValueKey(<span class="string">&#x27;FeedPage&#x27;</span>),</span><br><span class="line">          child: FeedPage(onSelect: (id) &#123;</span><br><span class="line">            <span class="comment">// 点击后进入详情页</span></span><br><span class="line">            selectedId = id;</span><br><span class="line">            showDetail = <span class="keyword">true</span>;</span><br><span class="line">            notifyListeners(); <span class="comment">// 通知 RouterDelegate 重建页面栈</span></span><br><span class="line">          &#125;),</span><br><span class="line">        ),</span><br><span class="line">        <span class="comment">// 如果状态为 showDetail，则压入详情页</span></span><br><span class="line">        <span class="keyword">if</span> (showDetail)</span><br><span class="line">          MaterialPage(</span><br><span class="line">            key: ValueKey(<span class="string">&#x27;DetailPage-<span class="subst">$selectedId</span>&#x27;</span>),</span><br><span class="line">            child: FeedDetailPage(id: selectedId!),</span><br><span class="line">          ),</span><br><span class="line">      ],</span><br><span class="line">      <span class="comment">/// <span class="language-markdown">Flutter 3.16+ 推荐使用 onDidRemovePage（替代 onPopPage）</span></span></span><br><span class="line">      <span class="comment">/// <span class="language-markdown">这个回调在页面被移除时触发</span></span></span><br><span class="line">      onDidRemovePage: (page) &#123;</span><br><span class="line">        debugPrint(<span class="string">&#x27;Page removed: <span class="subst">$&#123;page.key&#125;</span>&#x27;</span>);</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">/// <span class="language-markdown">监听页面出栈行为（比如系统返回键）</span></span></span><br><span class="line">      observers: [</span><br><span class="line">        _RouterPopObserver(onPop: () &#123;</span><br><span class="line">          <span class="keyword">if</span> (showDetail) &#123;</span><br><span class="line">            showDetail = <span class="keyword">false</span>;</span><br><span class="line">            notifyListeners(); <span class="comment">// 返回列表页</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;),</span><br><span class="line">      ],</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">从外部（比如浏览器 URL 变化）更新应用状态</span></span></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Future&lt;<span class="keyword">void</span>&gt; setNewRoutePath(HomePath configuration) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (configuration.id != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// URL 含有 id，进入详情页</span></span><br><span class="line">      selectedId = configuration.id;</span><br><span class="line">      showDetail = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 否则回到列表页</span></span><br><span class="line">      showDetail = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">自定义的 NavigatorObserver，用于监听页面 pop 事件</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_RouterPopObserver</span> <span class="keyword">extends</span> <span class="title">NavigatorObserver</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> VoidCallback onPop;</span><br><span class="line">  _RouterPopObserver(&#123;<span class="keyword">required</span> <span class="keyword">this</span>.onPop&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> didPop(Route route, Route? previousRoute) &#123;</span><br><span class="line">    onPop(); <span class="comment">// 通知 RouterDelegate 状态变化</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">Feed 列表页</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">点击某个 item 后，通过回调触发状态更新</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FeedPage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> ValueChanged&lt;<span class="built_in">String</span>&gt; onSelect;</span><br><span class="line">  <span class="keyword">const</span> FeedPage(&#123;<span class="keyword">super</span>.key, <span class="keyword">required</span> <span class="keyword">this</span>.onSelect&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(title: <span class="keyword">const</span> Text(<span class="string">&#x27;Feed&#x27;</span>)),</span><br><span class="line">      body: ListView(</span><br><span class="line">        children: [</span><br><span class="line">          ListTile(title: <span class="keyword">const</span> Text(<span class="string">&#x27;Item 1&#x27;</span>), onTap: () =&gt; onSelect(<span class="string">&#x27;1&#x27;</span>)),</span><br><span class="line">          ListTile(title: <span class="keyword">const</span> Text(<span class="string">&#x27;Item 2&#x27;</span>), onTap: () =&gt; onSelect(<span class="string">&#x27;2&#x27;</span>)),</span><br><span class="line">        ],</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">Feed 详情页</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">展示选中 item 的详细内容</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FeedDetailPage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> id;</span><br><span class="line">  <span class="keyword">const</span> FeedDetailPage(&#123;<span class="keyword">super</span>.key, <span class="keyword">required</span> <span class="keyword">this</span>.id&#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(title: Text(<span class="string">&#x27;Detail <span class="subst">$id</span>&#x27;</span>)),</span><br><span class="line">      body: Center(child: Text(<span class="string">&#x27;Detail page for item <span class="subst">$id</span>&#x27;</span>)),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>父级 Router（例如整个 AppRouter）就能把这个 HomeRouter 当作一个独立模块管理。这样每个子模块都能自管理页面栈，互不干扰。</p>
<h3 id="3-3-模态与全屏页面"><a href="#3-3-模态与全屏页面" class="headerlink" title="3.3 模态与全屏页面"></a>3.3 模态与全屏页面</h3><p>Declarative 导航也可以优雅地表达模态层（Modal）或 Overlay。<br>例如支付流程中，“确认支付”页面应在现有页面之上展示。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="language-markdown">应用入口，使用 Router API 构建声明式导航  </span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;  </span><br><span class="line">  <span class="keyword">const</span> MyApp(&#123;<span class="keyword">super</span>.key&#125;);  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@override</span>  </span><br><span class="line">  Widget build(BuildContext context) &#123;  </span><br><span class="line">    <span class="keyword">return</span> MaterialApp.router(  </span><br><span class="line">      routerDelegate: OrderRouter(),  </span><br><span class="line">      routeInformationParser: OrderRouteParser(),  </span><br><span class="line">      backButtonDispatcher: RootBackButtonDispatcher(),  </span><br><span class="line">    );  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/// <span class="language-markdown">路径状态对象：描述当前处于哪个页面状态  </span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderPath</span> </span>&#123;  </span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">bool</span> showPayment; <span class="comment">// 是否显示支付弹窗  </span></span><br><span class="line">  <span class="keyword">const</span> OrderPath(&#123;<span class="keyword">this</span>.showPayment = <span class="keyword">false</span>&#125;);  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/// <span class="language-markdown">RouteInformationParser 负责 URL ↔ OrderPath 的转换  </span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderRouteParser</span> <span class="keyword">extends</span> <span class="title">RouteInformationParser</span>&lt;<span class="title">OrderPath</span>&gt; </span>&#123;  </span><br><span class="line">  <span class="meta">@override</span>  </span><br><span class="line">  Future&lt;OrderPath&gt; parseRouteInformation(RouteInformation routeInformation) <span class="keyword">async</span> &#123;  </span><br><span class="line">    <span class="keyword">final</span> uri = routeInformation.uri;  </span><br><span class="line">    <span class="comment">// 根路径 -&gt; 订单页  </span></span><br><span class="line">    <span class="keyword">if</span> (uri.pathSegments.isEmpty) <span class="keyword">return</span> <span class="keyword">const</span> OrderPath();  </span><br><span class="line">    <span class="comment">// payment -&gt; 支付模态层  </span></span><br><span class="line">    <span class="keyword">if</span> (uri.pathSegments.length == <span class="number">1</span> &amp;&amp; uri.pathSegments.first == <span class="string">&#x27;payment&#x27;</span>) &#123;  </span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">const</span> OrderPath(showPayment: <span class="keyword">true</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">const</span> OrderPath();  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@override</span>  </span><br><span class="line">  RouteInformation? restoreRouteInformation(OrderPath configuration) &#123;  </span><br><span class="line">    <span class="comment">// 根据状态生成对应 URL    </span></span><br><span class="line">    <span class="keyword">if</span> (configuration.showPayment) &#123;  </span><br><span class="line">      <span class="keyword">return</span> RouteInformation(uri: <span class="built_in">Uri</span>(path: <span class="string">&#x27;/payment&#x27;</span>));  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> RouteInformation(uri: <span class="built_in">Uri</span>(path: <span class="string">&#x27;/&#x27;</span>));  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/// <span class="language-markdown">RouterDelegate：声明式地控制页面栈  </span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderRouter</span> <span class="keyword">extends</span> <span class="title">RouterDelegate</span>&lt;<span class="title">OrderPath</span>&gt;  </span></span><br><span class="line"><span class="class">    <span class="title">with</span> <span class="title">ChangeNotifier</span>, <span class="title">PopNavigatorRouterDelegateMixin</span>&lt;<span class="title">OrderPath</span>&gt; </span>&#123;  </span><br><span class="line">  <span class="meta">@override</span>  </span><br><span class="line">  <span class="keyword">final</span> GlobalKey&lt;NavigatorState&gt; navigatorKey = GlobalKey&lt;NavigatorState&gt;();  </span><br><span class="line">  </span><br><span class="line">  <span class="built_in">bool</span> showPayment = <span class="keyword">false</span>;  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@override</span>  </span><br><span class="line">  Widget build(BuildContext context) &#123;  </span><br><span class="line">    <span class="keyword">return</span> Navigator(  </span><br><span class="line">      key: navigatorKey,  </span><br><span class="line">      <span class="comment">/// <span class="language-markdown">根据状态声明页面栈  </span></span></span><br><span class="line">      pages: [  </span><br><span class="line">        <span class="comment">// 基础页面：订单页  </span></span><br><span class="line">        MaterialPage(  </span><br><span class="line">          key: <span class="keyword">const</span> ValueKey(<span class="string">&#x27;OrderPage&#x27;</span>),  </span><br><span class="line">          child: OrderPage(onPay: () &#123;  </span><br><span class="line">            showPayment = <span class="keyword">true</span>;  </span><br><span class="line">            notifyListeners(); <span class="comment">// 通知刷新页面栈  </span></span><br><span class="line">          &#125;),  </span><br><span class="line">        ),  </span><br><span class="line">        <span class="comment">// 模态页：支付页  </span></span><br><span class="line">        <span class="keyword">if</span> (showPayment)  </span><br><span class="line">          MaterialPage(  </span><br><span class="line">            key: <span class="keyword">const</span> ValueKey(<span class="string">&#x27;PaymentSheet&#x27;</span>),  </span><br><span class="line">            fullscreenDialog: <span class="keyword">true</span>, <span class="comment">// &lt;-- 核心参数：模态展示  </span></span><br><span class="line">            child: PaymentSheet(onClose: () &#123;  </span><br><span class="line">              showPayment = <span class="keyword">false</span>;  </span><br><span class="line">              notifyListeners();  </span><br><span class="line">            &#125;),  </span><br><span class="line">          ),  </span><br><span class="line">      ],  </span><br><span class="line">      <span class="comment">/// <span class="language-markdown">监听页面移除  </span></span></span><br><span class="line">      onDidRemovePage: (page) &#123;  </span><br><span class="line">        debugPrint(<span class="string">&#x27;Page removed: <span class="subst">$&#123;page.key&#125;</span>&#x27;</span>);  </span><br><span class="line">      &#125;,  </span><br><span class="line">      observers: [  </span><br><span class="line">        <span class="comment">// 监听返回（pop）操作  </span></span><br><span class="line">        _RouterPopObserver(onPop: () &#123;  </span><br><span class="line">          <span class="keyword">if</span> (showPayment) &#123;  </span><br><span class="line">            showPayment = <span class="keyword">false</span>;  </span><br><span class="line">            notifyListeners();  </span><br><span class="line">          &#125;  </span><br><span class="line">        &#125;),  </span><br><span class="line">      ],  </span><br><span class="line">    );  </span><br><span class="line">  &#125;  </span><br><span class="line">  <span class="comment">/// <span class="language-markdown">外部（URL变化）状态同步  </span></span></span><br><span class="line">  <span class="meta">@override</span>  </span><br><span class="line">  Future&lt;<span class="keyword">void</span>&gt; setNewRoutePath(OrderPath configuration) <span class="keyword">async</span> &#123;  </span><br><span class="line">    showPayment = configuration.showPayment;  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/// <span class="language-markdown">Navigator 观察者，监听页面出栈  </span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_RouterPopObserver</span> <span class="keyword">extends</span> <span class="title">NavigatorObserver</span> </span>&#123;  </span><br><span class="line">  <span class="keyword">final</span> VoidCallback onPop;  </span><br><span class="line">  _RouterPopObserver(&#123;<span class="keyword">required</span> <span class="keyword">this</span>.onPop&#125;);  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@override</span>  </span><br><span class="line">  <span class="keyword">void</span> didPop(Route route, Route? previousRoute) &#123;  </span><br><span class="line">    onPop();  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/// <span class="language-markdown">订单页：点击“去支付”打开模态层  </span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderPage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;  </span><br><span class="line">  <span class="keyword">final</span> VoidCallback onPay;  </span><br><span class="line">  <span class="keyword">const</span> OrderPage(&#123;<span class="keyword">super</span>.key, <span class="keyword">required</span> <span class="keyword">this</span>.onPay&#125;);  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@override</span>  </span><br><span class="line">  Widget build(BuildContext context) &#123;  </span><br><span class="line">    <span class="keyword">return</span> Scaffold(  </span><br><span class="line">      appBar: AppBar(title: <span class="keyword">const</span> Text(<span class="string">&#x27;Order Page&#x27;</span>)),  </span><br><span class="line">      body: Center(  </span><br><span class="line">        child: ElevatedButton(  </span><br><span class="line">          onPressed: onPay,  </span><br><span class="line">          child: <span class="keyword">const</span> Text(<span class="string">&#x27;去支付&#x27;</span>),  </span><br><span class="line">        ),  </span><br><span class="line">      ),  </span><br><span class="line">    );  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/// <span class="language-markdown">支付模态页：全屏对话框式展示  </span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PaymentSheet</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;  </span><br><span class="line">  <span class="keyword">final</span> VoidCallback onClose;  </span><br><span class="line">  <span class="keyword">const</span> PaymentSheet(&#123;<span class="keyword">super</span>.key, <span class="keyword">required</span> <span class="keyword">this</span>.onClose&#125;);  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@override</span>  </span><br><span class="line">  Widget build(BuildContext context) &#123;  </span><br><span class="line">    <span class="keyword">return</span> Scaffold(  </span><br><span class="line">      appBar: AppBar(  </span><br><span class="line">        title: <span class="keyword">const</span> Text(<span class="string">&#x27;支付确认&#x27;</span>),  </span><br><span class="line">        leading: IconButton(  </span><br><span class="line">          icon: <span class="keyword">const</span> Icon(Icons.close),  </span><br><span class="line">          onPressed: onClose, <span class="comment">// 点击关闭  </span></span><br><span class="line">        ),  </span><br><span class="line">      ),  </span><br><span class="line">      body: Center(  </span><br><span class="line">        child: Column(  </span><br><span class="line">          mainAxisSize: MainAxisSize.min,  </span><br><span class="line">          children: [  </span><br><span class="line">            <span class="keyword">const</span> Text(<span class="string">&#x27;确认支付 ¥99.00&#x27;</span>),  </span><br><span class="line">            <span class="keyword">const</span> SizedBox(height: <span class="number">16</span>),  </span><br><span class="line">            ElevatedButton(  </span><br><span class="line">              onPressed: () &#123;  </span><br><span class="line">                ScaffoldMessenger.of(context).showSnackBar(  </span><br><span class="line">                  <span class="keyword">const</span> SnackBar(content: Text(<span class="string">&#x27;支付成功！&#x27;</span>)),  </span><br><span class="line">                );  </span><br><span class="line">                onClose();  </span><br><span class="line">              &#125;,  </span><br><span class="line">              child: <span class="keyword">const</span> Text(<span class="string">&#x27;确认支付&#x27;</span>),  </span><br><span class="line">            ),  </span><br><span class="line">          ],  </span><br><span class="line">        ),  </span><br><span class="line">      ),  </span><br><span class="line">    );  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><video src="https://mark-down-dc.oss-cn-hangzhou.aliyuncs.com/key_blog/declarative_modal_251008.mp4" controls="controls" width="30%"></video><br>当 showPayment &#x3D; true 时，RouterDelegate 重建页面栈，自动展示支付弹窗。关闭弹窗时更新状态，然后rebuild，弹窗消失。</p>
<blockquote>
<p>这样做的优势：模态行为完全由状态驱动，无需手动 showDialog() 或 Navigator.push()。</p>
</blockquote>
<h3 id="3-4-参数与返回值：用状态而非回调"><a href="#3-4-参数与返回值：用状态而非回调" class="headerlink" title="3.4 参数与返回值：用状态而非回调"></a>3.4 参数与返回值：用状态而非回调</h3><p>在声明式导航中，没有 <code>Navigator.pop(result)</code> 这样的“回传机制”，而是通过<strong>共享状态（AppState、Provider、Riverpod）</strong> 传递结果。</p>
<p>例如，编辑个人资料的流程：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (state.editingProfile) &#123;</span><br><span class="line">  pages.add(MaterialPage(child: EditProfilePage(</span><br><span class="line">    onSubmit: (newProfile) &#123;</span><br><span class="line">      appState.updateProfile(newProfile);</span><br><span class="line">      appState.editingProfile = <span class="keyword">false</span>;</span><br><span class="line">      notifyListeners();</span><br><span class="line">    &#125;,</span><br><span class="line">  )));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>状态更新 → 页面自动关闭 → 数据同步，无需 callback 层层传递。</p>
<h3 id="3-5-动态路由注册与模块热更新"><a href="#3-5-动态路由注册与模块热更新" class="headerlink" title="3.5 动态路由注册与模块热更新"></a>3.5 动态路由注册与模块热更新</h3><p>在大型应用或插件化框架中，有时路由并非写死在代码中，而是<strong>根据配置动态加载</strong>。例如一个“活动中心”模块在运行时下发配置：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> featureRoutes = &#123;</span><br><span class="line">  <span class="string">&#x27;promo&#x27;</span>: (context) =&gt; PromoPage(),</span><br><span class="line">  <span class="string">&#x27;survey&#x27;</span>: (context) =&gt; SurveyPage(),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (featureRoutes.containsKey(uri.pathSegments.first)) &#123;</span><br><span class="line">  <span class="keyword">return</span> MaterialPage(child: featureRoutes[uri.pathSegments.first]!(context));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种“动态注册”让 Navigator 2.0 更适合渐进式加载与灰度发布场景。</p>
<h2 id="4-鉴权与路由守卫"><a href="#4-鉴权与路由守卫" class="headerlink" title="4. 鉴权与路由守卫"></a>4. 鉴权与路由守卫</h2><p>在大型应用中，导航不仅仅是页面切换，更涉及<strong>权限控制</strong>：用户是否登录、是否有权限访问某些功能页。Navigator 2.0 提供的 <strong>声明式导航</strong> 可以非常自然地处理这些场景。</p>
<h3 id="4-1-为什么需要路由守卫"><a href="#4-1-为什么需要路由守卫" class="headerlink" title="4.1 为什么需要路由守卫"></a>4.1 为什么需要路由守卫</h3><p>在命令式导航中，我们通常在页面 push 之前检查登录状态：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!auth.isLoggedIn) &#123;</span><br><span class="line">  Navigator.push(context, MaterialPageRoute(builder: (_) =&gt; LoginPage()));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  Navigator.push(context, MaterialPageRoute(builder: (_) =&gt; HomePage()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种做法存在几个问题：</p>
<ol>
<li><strong>分散逻辑</strong>：每个页面都要重复判断，容易遗漏。</li>
<li><strong>全局状态难控制</strong>：多栈&#x2F;模态页情况下，用户可能绕过判断。</li>
<li><strong>难以同步 URL</strong>：在 Web 或多端场景下，直接 push 并不能保证地址栏与状态一致。</li>
</ol>
<p><strong>解决方案</strong>：在 RouterDelegate 中统一判断登录状态，根据状态直接构建页面栈。</p>
<h3 id="4-2-声明式导航下的登录守卫策略"><a href="#4-2-声明式导航下的登录守卫策略" class="headerlink" title="4.2 声明式导航下的登录守卫策略"></a>4.2 声明式导航下的登录守卫策略</h3><p>核心思路：</p>
<ol>
<li><strong>统一状态管理</strong>：使用 Provider、Riverpod 或自己维护的 AppState，保存登录状态（如 isLoggedIn、token）。</li>
<li><strong>RouterDelegate 控制页面栈</strong>：根据登录状态决定页面栈内容，而不是每次 push&#x2F;pop 时检查：</li>
</ol>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthRouter</span> <span class="keyword">extends</span> <span class="title">RouterDelegate</span>&lt;<span class="title">AppPath</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="title">with</span> <span class="title">ChangeNotifier</span>, <span class="title">PopNavigatorRouterDelegateMixin</span>&lt;<span class="title">AppPath</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> GlobalKey&lt;NavigatorState&gt; navigatorKey = GlobalKey();</span><br><span class="line">  <span class="keyword">final</span> AuthState auth;</span><br><span class="line"></span><br><span class="line">  AuthRouter(<span class="keyword">this</span>.auth);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="comment">// 登录态判断</span></span><br><span class="line">    <span class="built_in">List</span>&lt;Page&gt; pages;</span><br><span class="line">    <span class="keyword">if</span> (!auth.isLoggedIn) &#123;</span><br><span class="line">      <span class="comment">// 未登录 → 仅显示登录页</span></span><br><span class="line">      pages = [MaterialPage(child: LoginPage(onLogin: () &#123;</span><br><span class="line">        auth.login();       <span class="comment">// 更新状态</span></span><br><span class="line">        notifyListeners();  <span class="comment">// 重新构建页面栈</span></span><br><span class="line">      &#125;))];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 已登录 → 显示主页面</span></span><br><span class="line">      pages = [MaterialPage(child: HomePage())];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Navigator(</span><br><span class="line">      key: navigatorKey,</span><br><span class="line">      pages: pages,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Future&lt;<span class="keyword">void</span>&gt; setNewRoutePath(AppPath configuration) <span class="keyword">async</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-3-典型登录流程"><a href="#4-3-典型登录流程" class="headerlink" title="4.3 典型登录流程"></a>4.3 典型登录流程</h3><ol>
<li><strong>应用启动</strong> → RouterDelegate 根据 auth.isLoggedIn 判断：<ul>
<li>已登录，构建主页面栈</li>
<li>未登录，构建登录页</li>
</ul>
</li>
<li><strong>用户操作登录</strong> → 更新 AuthState → 调用 notifyListeners() → 页面栈重建</li>
<li><strong>登录成功后</strong> → 可以自动导航到用户请求的目标页（deep link 或特定流程页）</li>
</ol>
<blockquote>
<p>这就是 <strong>声明式导航的优势</strong>：页面栈完全由状态驱动，避免散落在各处的权限检查逻辑。</p>
</blockquote>
<h3 id="4-4-用户体验优化"><a href="#4-4-用户体验优化" class="headerlink" title="4.4 用户体验优化"></a>4.4 用户体验优化</h3><ol>
<li><strong>加载页 &#x2F; 验证中间页</strong>：在检查 token 或刷新 session 时显示 Loading 页面，避免闪屏或错误跳转。</li>
</ol>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (auth.isChecking) &#123;</span><br><span class="line">  <span class="keyword">return</span> [MaterialPage(child: LoadingPage())];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><strong>统一过渡动画</strong>：在 RouterDelegate 里统一管理 Page 的动画属性（fullscreenDialog &#x2F; CustomPage），保证不同流程页面切换效果一致。</li>
<li><strong>深链跳转处理</strong>：用户通过外部链接进入受限页面 → 先展示登录页 → 登录成功后自动跳转目标页。只需在 RouterDelegate 中维护一个 pendingPath 状态即可。</li>
</ol>
<h2 id="5-多端导航适配"><a href="#5-多端导航适配" class="headerlink" title="5. 多端导航适配"></a>5. 多端导航适配</h2><p>Declarative 导航（声明式导航）的一大优势，是它<strong>天然适配多端场景</strong>。无论是 <strong>Mobile、Web 还是 Desktop</strong>，本质上都可以通过统一的 <strong>状态驱动页面栈</strong>。</p>
<p>但在不同端上，<strong>导航机制与系统行为存在细微差异</strong>，尤其体现在 URL 同步、浏览器历史、系统事件唤起等方面。</p>
<h3 id="5-1-Web-端差异与适配"><a href="#5-1-Web-端差异与适配" class="headerlink" title="5.1 Web 端差异与适配"></a>5.1 Web 端差异与适配</h3><p>在 Web 上，主要是使用URL 。Router 2.0 提供了 RouteInformationParser 和 RouteInformationProvider，负责在 <strong>URL 与内部状态</strong>之间同步：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppRouteParser</span> <span class="keyword">extends</span> <span class="title">RouteInformationParser</span>&lt;<span class="title">AppPath</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Future&lt;AppPath&gt; parseRouteInformation(RouteInformation info) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> uri = info.uri;</span><br><span class="line">    <span class="keyword">if</span> (uri.pathSegments.isEmpty) <span class="keyword">return</span> <span class="keyword">const</span> AppPath.home();</span><br><span class="line">    <span class="keyword">if</span> (uri.pathSegments.first == <span class="string">&#x27;detail&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> AppPath.detail(uri.pathSegments.elementAt(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">const</span> AppPath.home();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  RouteInformation restoreRouteInformation(AppPath path) &#123;</span><br><span class="line">    <span class="keyword">if</span> (path.id != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> RouteInformation(uri: <span class="built_in">Uri</span>(path: <span class="string">&#x27;/detail/<span class="subst">$&#123;path.id&#125;</span>&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> RouteInformation(uri: <span class="built_in">Uri</span>(path: <span class="string">&#x27;/&#x27;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>关键特性：</strong></p>
<ul>
<li>支持浏览器刷新后状态恢复；</li>
<li>URL 直接访问 &#x2F;detail&#x2F;123 时能深链到详情页；</li>
<li>浏览器返回键会自动触发 setNewRoutePath，同步内部状态。</li>
</ul>
<blockquote>
<p>Flutter Web 下的返回键和浏览器地址栏行为依赖于 RouteInformationProvider，若发现无法同步，可检查 MaterialApp.router 是否配置 routeInformationParser。</p>
</blockquote>
<h3 id="5-2-Desktop-端差异与事件监听"><a href="#5-2-Desktop-端差异与事件监听" class="headerlink" title="5.2 Desktop 端差异与事件监听"></a>5.2 Desktop 端差异与事件监听</h3><p>在 Desktop（Windows &#x2F; macOS &#x2F; Linux）上，导航差异不体现在 URL，而在于<strong>系统事件</strong>：</p>
<ul>
<li>用户可能通过“打开文件”或“URL scheme”启动应用；</li>
<li>应用可能同时存在多个窗口，每个窗口对应独立 Navigator。</li>
</ul>
<p>Flutter 提供了 PlatformDispatcher 与 Window API，可以捕获这类事件：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DesktopRouterDelegate</span> <span class="keyword">extends</span> <span class="title">RouterDelegate</span>&lt;<span class="title">AppPath</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="title">with</span> <span class="title">ChangeNotifier</span>, <span class="title">PopNavigatorRouterDelegateMixin</span>&lt;<span class="title">AppPath</span>&gt; </span>&#123;</span><br><span class="line">  DesktopRouterDelegate() &#123;</span><br><span class="line">    <span class="comment">// 监听系统事件，例如 macOS 上的文件打开</span></span><br><span class="line">    PlatformDispatcher.instance.onOpenUri = (<span class="built_in">Uri</span> uri) &#123;</span><br><span class="line">      <span class="keyword">if</span> (uri.pathSegments.first == <span class="string">&#x27;detail&#x27;</span>) &#123;</span><br><span class="line">        selectedId = uri.pathSegments.elementAt(<span class="number">1</span>);</span><br><span class="line">        showDetail = <span class="keyword">true</span>;</span><br><span class="line">        notifyListeners();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">String?</span> selectedId;</span><br><span class="line">  <span class="built_in">bool</span> showDetail = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">final</span> GlobalKey&lt;NavigatorState&gt; navigatorKey = GlobalKey();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Navigator(</span><br><span class="line">      key: navigatorKey,</span><br><span class="line">      pages: [</span><br><span class="line">        MaterialPage(child: HomePage(onSelect: _openDetail)),</span><br><span class="line">        <span class="keyword">if</span> (showDetail)</span><br><span class="line">          MaterialPage(child: DetailPage(id: selectedId!)),</span><br><span class="line">      ],</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> _openDetail(<span class="built_in">String</span> id) &#123;</span><br><span class="line">    selectedId = id;</span><br><span class="line">    showDetail = <span class="keyword">true</span>;</span><br><span class="line">    notifyListeners();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Future&lt;<span class="keyword">void</span>&gt; setNewRoutePath(AppPath configuration) <span class="keyword">async</span> &#123;</span><br><span class="line">    selectedId = configuration.id;</span><br><span class="line">    showDetail = selectedId != <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这意味着：我们可以让桌面端应用响应系统级行为（如「点击文件 → 打开详情页」），而不影响移动端的路由逻辑。</p>
</blockquote>
<h3 id="5-3-移动端与多端统一封装"><a href="#5-3-移动端与多端统一封装" class="headerlink" title="5.3 移动端与多端统一封装"></a>5.3 移动端与多端统一封装</h3><p>移动端（iOS &#x2F; Android）通常没有 URL，同样的导航逻辑就依赖在内存中维护的 <strong>App 状态</strong>。</p>
<p>为了兼容所有平台，可以定义一个抽象接口：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AppNavigator</span> </span>&#123;</span><br><span class="line">  <span class="keyword">void</span> toHome();</span><br><span class="line">  <span class="keyword">void</span> toDetail(<span class="built_in">String</span> id);</span><br><span class="line">  <span class="keyword">void</span> back();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DeclarativeNavigator</span> <span class="keyword">extends</span> <span class="title">AppNavigator</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> ValueNotifier&lt;AppPath&gt; state;</span><br><span class="line">  DeclarativeNavigator(<span class="keyword">this</span>.state);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> toHome() =&gt; state.value = <span class="keyword">const</span> AppPath.home();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> toDetail(<span class="built_in">String</span> id) =&gt; state.value = AppPath.detail(id);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> back() =&gt; state.value = <span class="keyword">const</span> AppPath.home();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在主入口中统一使用：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> appState = ValueNotifier&lt;AppPath&gt;(<span class="keyword">const</span> AppPath.home());</span><br><span class="line"></span><br><span class="line">MaterialApp.router(</span><br><span class="line">  routerDelegate: AppRouterDelegate(appState),</span><br><span class="line">  routeInformationParser: AppRouteParser(),</span><br><span class="line">  routeInformationProvider: PlatformRouteProvider(appState),</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>这样，<strong>所有端的导航事件都可以通过 AppNavigator 调用</strong>，而底层根据平台差异分别实现 URL 更新、系统事件监听或状态切换。</p>
<h3 id="5-4-SEO-与路径可读性（Web-专属）"><a href="#5-4-SEO-与路径可读性（Web-专属）" class="headerlink" title="5.4 SEO 与路径可读性（Web 专属）"></a>5.4 SEO 与路径可读性（Web 专属）</h3><p>在 Web 下，Declarative Router 的另一优势是——<strong>路径可控、可读性强</strong>。相比传统的 hash 路由（如 <code>/#/detail?id=3</code>），Declarative Router 可以输出 <code>/detail/3</code> 这种结构化 URL，利于：</p>
<ul>
<li>搜索引擎索引；</li>
<li>页面直接分享；</li>
<li>SSR 或预渲染。</li>
</ul>
<blockquote>
<p>小技巧：可结合 go_router 等三方库进一步简化多端导航；若要支持静态资源预渲染，可配合 flutter build web –base-href 指定路径。</p>
</blockquote>
<table>
<thead>
<tr>
<th><strong>平台</strong></th>
<th><strong>导航差异点</strong></th>
<th><strong>解决方案</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>Mobile</strong></td>
<td>内存状态驱动</td>
<td>RouterDelegate 状态管理</td>
</tr>
<tr>
<td><strong>Web</strong></td>
<td>URL 同步、刷新恢复</td>
<td>RouteInformationParser &#x2F; Provider</td>
</tr>
<tr>
<td><strong>Desktop</strong></td>
<td>系统事件、文件唤起</td>
<td>PlatformDispatcher 事件监听</td>
</tr>
</tbody></table>
<p>统一 Declarative 导航的核心，是“<strong>状态 → 页面栈的单向映射</strong>”。只要将平台特性（URL、系统事件）转化为统一的路由状态，就能在所有端上共享同一套逻辑。</p>
<h2 id="6-调试、测试与工程模板"><a href="#6-调试、测试与工程模板" class="headerlink" title="6. 调试、测试与工程模板"></a>6. 调试、测试与工程模板</h2><p>Declarative 导航的思路虽然清晰，但在真实项目中经常因为 <strong>状态不同步、URL 不更新、Pop 无效</strong> 等问题很难调试。</p>
<p>下面讲讲如何<strong>定位问题、测试导航逻辑、以及组织可扩展的工程结构</strong>。</p>
<h3 id="6-1-调试技巧"><a href="#6-1-调试技巧" class="headerlink" title="6.1 调试技巧"></a>6.1 调试技巧</h3><h4 id="6-1-1-RouterDelegate-的生命周期"><a href="#6-1-1-RouterDelegate-的生命周期" class="headerlink" title="6.1.1 RouterDelegate 的生命周期"></a>6.1.1 RouterDelegate 的生命周期</h4><p>Declarative 导航的核心在于状态驱动页面栈，因此最需要监控的是——<strong>状态何时变化、为何变化</strong>。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppRouterDelegate</span> <span class="keyword">extends</span> <span class="title">RouterDelegate</span>&lt;<span class="title">AppPath</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="title">with</span> <span class="title">ChangeNotifier</span>, <span class="title">PopNavigatorRouterDelegateMixin</span>&lt;<span class="title">AppPath</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> ValueNotifier&lt;AppPath&gt; appState;</span><br><span class="line">  AppRouterDelegate(<span class="keyword">this</span>.appState) &#123;</span><br><span class="line">    appState.addListener(() &#123;</span><br><span class="line">      debugPrint(<span class="string">&#x27;🔄 Route changed to: <span class="subst">$&#123;appState.value&#125;</span>&#x27;</span>);</span><br><span class="line">      notifyListeners();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    debugPrint(<span class="string">&#x27;🧩 Rebuilding Navigator with <span class="subst">$&#123;appState.value&#125;</span>&#x27;</span>);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Future&lt;<span class="keyword">void</span>&gt; setNewRoutePath(AppPath configuration) <span class="keyword">async</span> &#123;</span><br><span class="line">    debugPrint(<span class="string">&#x27;🌐 New route from URL: <span class="subst">$configuration</span>&#x27;</span>);</span><br><span class="line">    appState.value = configuration;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>调试重点：</strong><br>setNewRoutePath() 被调用说明来源是“URL 变化”或“浏览器返回”。<br>notifyListeners() → build() → Navigator 触发重建，是内部状态变化。</p>
</blockquote>
<h4 id="6-1-2-Flutter-DevTools-查看-rebuild"><a href="#6-1-2-Flutter-DevTools-查看-rebuild" class="headerlink" title="6.1.2 Flutter DevTools 查看 rebuild"></a>6.1.2 Flutter DevTools 查看 rebuild</h4><p>打开 DevTools 的 <strong>“Widget rebuild profiler”</strong>，你能看到 RouterDelegate、Navigator、Page 的 rebuild 频率。若某页面频繁重建，说明你的状态管理可能“太粗”，可考虑拆分子状态。</p>
<h4 id="6-1-3-常见-Bug-与排查"><a href="#6-1-3-常见-Bug-与排查" class="headerlink" title="6.1.3 常见 Bug 与排查"></a>6.1.3 常见 Bug 与排查</h4><table>
<thead>
<tr>
<th><strong>问题</strong></th>
<th><strong>原因</strong></th>
<th><strong>修复思路</strong></th>
</tr>
</thead>
<tbody><tr>
<td>页面反复 push</td>
<td>notifyListeners() 多次触发</td>
<td>在 setState 或异步回调中去重</td>
</tr>
<tr>
<td>pop 不生效</td>
<td>未正确实现 onDidRemovePage &#x2F; didPop</td>
<td>改为使用 NavigatorObserver</td>
</tr>
<tr>
<td>URL 不同步</td>
<td>RouteInformationParser 未实现 restoreRouteInformation()</td>
<td>确保状态更新时正确返回 URL</td>
</tr>
</tbody></table>
<h3 id="6-2-测试策略"><a href="#6-2-测试策略" class="headerlink" title="6.2 测试策略"></a>6.2 测试策略</h3><p>Declarative 导航最大的好处之一，就是逻辑可测试。传统 Navigator 1.0 的 push&#x2F;pop 很难验证，而现在，我们可以直接测试状态与解析。</p>
<h4 id="6-2-1-单元测试：验证-RouteParser-输入输出"><a href="#6-2-1-单元测试：验证-RouteParser-输入输出" class="headerlink" title="6.2.1 单元测试：验证 RouteParser 输入输出"></a>6.2.1 单元测试：验证 RouteParser 输入输出</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter_test/flutter_test.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  test(<span class="string">&#x27;should parse /detail/123 correctly&#x27;</span>, () <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> parser = AppRouteParser();</span><br><span class="line">    <span class="keyword">final</span> route = <span class="keyword">await</span> parser.parseRouteInformation(</span><br><span class="line">      <span class="keyword">const</span> RouteInformation(uri: <span class="built_in">Uri</span>(path: <span class="string">&#x27;/detail/123&#x27;</span>)),</span><br><span class="line">    );</span><br><span class="line">    expect(route.id, <span class="string">&#x27;123&#x27;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  test(<span class="string">&#x27;should restore route information&#x27;</span>, () &#123;</span><br><span class="line">    <span class="keyword">final</span> parser = AppRouteParser();</span><br><span class="line">    <span class="keyword">final</span> info = parser.restoreRouteInformation(AppPath.detail(<span class="string">&#x27;99&#x27;</span>));</span><br><span class="line">    expect(info.uri.path, <span class="string">&#x27;/detail/99&#x27;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>测试要点：<br> 只需 Mock RouteInformation，无需真正构建 UI。<br>确保 &#x2F;detail&#x2F;xxx 与 AppPath.detail(id) 双向同步。</p>
</blockquote>
<h4 id="6-2-2-集成测试：模拟用户导航行为"><a href="#6-2-2-集成测试：模拟用户导航行为" class="headerlink" title="6.2.2 集成测试：模拟用户导航行为"></a>6.2.2 集成测试：模拟用户导航行为</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">testWidgets(<span class="string">&#x27;navigates from FeedPage to DetailPage&#x27;</span>, (tester) <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">await</span> tester.pumpWidget(<span class="keyword">const</span> MyApp());</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 点击第一个 item</span></span><br><span class="line">  <span class="keyword">await</span> tester.tap(find.text(<span class="string">&#x27;Item 1&#x27;</span>));</span><br><span class="line">  <span class="keyword">await</span> tester.pumpAndSettle();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 断言跳转到详情页</span></span><br><span class="line">  expect(find.text(<span class="string">&#x27;Detail page for item 1&#x27;</span>), findsOneWidget);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 模拟返回</span></span><br><span class="line">  <span class="keyword">await</span> tester.pageBack();</span><br><span class="line">  <span class="keyword">await</span> tester.pumpAndSettle();</span><br><span class="line"></span><br><span class="line">  expect(find.text(<span class="string">&#x27;Feed&#x27;</span>), findsOneWidget);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>建议</strong>：<br>在 MyApp 中暴露 ValueNotifier<code>&lt;AppPath&gt;</code>，便于测试时直接控制路由。<br>集成测试可以覆盖登录守卫、模态弹窗、深链跳转等复杂场景。</p>
</blockquote>
<h3 id="6-3-工程模板：从-Demo-到可维护架构"><a href="#6-3-工程模板：从-Demo-到可维护架构" class="headerlink" title="6.3 工程模板：从 Demo 到可维护架构"></a>6.3 工程模板：从 Demo 到可维护架构</h3><p>Declarative 导航最怕“一坨写在一个文件里”。合理的结构能让你轻松迁移到 go_router 或 auto_route，也方便后期接入权限、深链、A&#x2F;B 实验等逻辑。</p>
<p>下面是一个完整可运行的 Flutter Declarative Navigation 最小化项目结构，包含 <strong>3 个页面（Home &#x2F; Detail &#x2F; Login）</strong>、<strong>RouteParser + RouterDelegate</strong>、以及一个简单的状态管理。</p>
<p>项目结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">lib/</span><br><span class="line">  main.dart</span><br><span class="line">  routes/</span><br><span class="line">    app_route_parser.dart</span><br><span class="line">    app_router_delegate.dart</span><br><span class="line">  models/</span><br><span class="line">    app_path.dart</span><br><span class="line">  pages/</span><br><span class="line">    home_page.dart</span><br><span class="line">    detail_page.dart</span><br><span class="line">    login_page.dart</span><br></pre></td></tr></table></figure>
<p><strong>lib&#x2F;main.dart</strong></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;models/app_path.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;routes/app_route_parser.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;routes/app_router_delegate.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main() &#123;  </span><br><span class="line">  runApp(MyApp());  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;  </span><br><span class="line">  <span class="keyword">final</span> ValueNotifier&lt;AppPath&gt; appState = ValueNotifier(<span class="keyword">const</span> AppPath.home());  </span><br><span class="line">  </span><br><span class="line">  MyApp(&#123;<span class="keyword">super</span>.key&#125;);  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@override</span>  </span><br><span class="line">  Widget build(BuildContext context) &#123;  </span><br><span class="line">    <span class="keyword">return</span> MaterialApp.router(  </span><br><span class="line">      title: <span class="string">&#x27;Declarative Nav Demo&#x27;</span>,  </span><br><span class="line">      routerDelegate: AppRouterDelegate(appState),  </span><br><span class="line">      routeInformationParser: AppRouteParser(),  </span><br><span class="line">      backButtonDispatcher: RootBackButtonDispatcher(),  </span><br><span class="line">    );  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>lib&#x2F;models&#x2F;app_path.dart</strong></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/foundation.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">声明式路由路径结构体  </span></span></span><br><span class="line"><span class="meta">@immutable</span>  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppPath</span> </span>&#123;  </span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String?</span> detailId;  </span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">bool</span> isLogin;  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> AppPath.home()  </span><br><span class="line">      : detailId = <span class="keyword">null</span>,  </span><br><span class="line">        isLogin = <span class="keyword">false</span>;  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> AppPath.detail(<span class="keyword">this</span>.detailId) : isLogin = <span class="keyword">false</span>;  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> AppPath.login()  </span><br><span class="line">      : detailId = <span class="keyword">null</span>,  </span><br><span class="line">        isLogin = <span class="keyword">true</span>;  </span><br><span class="line">  </span><br><span class="line">  <span class="built_in">bool</span> <span class="keyword">get</span> isHomePage =&gt; !isLogin &amp;&amp; detailId == <span class="keyword">null</span>;  </span><br><span class="line">  <span class="built_in">bool</span> <span class="keyword">get</span> isDetailPage =&gt; !isLogin &amp;&amp; detailId != <span class="keyword">null</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>lib&#x2F;routes&#x2F;app_route_parser.dart</strong></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;../models/app_path.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">URL &lt;-&gt; AppPath 转换器  </span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppRouteParser</span> <span class="keyword">extends</span> <span class="title">RouteInformationParser</span>&lt;<span class="title">AppPath</span>&gt; </span>&#123;  </span><br><span class="line">  <span class="meta">@override</span>  </span><br><span class="line">  Future&lt;AppPath&gt; parseRouteInformation(RouteInformation routeInformation) <span class="keyword">async</span> &#123;  </span><br><span class="line">    <span class="keyword">final</span> uri = routeInformation.uri;  </span><br><span class="line">    <span class="keyword">if</span> (uri.pathSegments.isEmpty) <span class="keyword">return</span> <span class="keyword">const</span> AppPath.home();  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (uri.pathSegments.first == <span class="string">&#x27;login&#x27;</span>) &#123;  </span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">const</span> AppPath.login();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (uri.pathSegments.first == <span class="string">&#x27;detail&#x27;</span> &amp;&amp; uri.pathSegments.length == <span class="number">2</span>) &#123;  </span><br><span class="line">      <span class="keyword">return</span> AppPath.detail(uri.pathSegments[<span class="number">1</span>]);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">const</span> AppPath.home();  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@override</span>  </span><br><span class="line">  RouteInformation? restoreRouteInformation(AppPath configuration) &#123;  </span><br><span class="line">    <span class="keyword">if</span> (configuration.isLogin) &#123;  </span><br><span class="line">      <span class="keyword">return</span> RouteInformation(uri: <span class="built_in">Uri</span>(path: <span class="string">&#x27;/login&#x27;</span>));  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> (configuration.isDetailPage) &#123;  </span><br><span class="line">      <span class="keyword">return</span> RouteInformation(uri: <span class="built_in">Uri</span>(path: <span class="string">&#x27;/detail/<span class="subst">$&#123;configuration.detailId&#125;</span>&#x27;</span>));  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> RouteInformation(uri: <span class="built_in">Uri</span>(path: <span class="string">&#x27;/&#x27;</span>));  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>lib&#x2F;routes&#x2F;app_router_delegate.dart</strong></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;../models/app_path.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;../pages/home_page.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;../pages/detail_page.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;../pages/login_page.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">核心路由委托：根据状态生成页面栈  </span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppRouterDelegate</span> <span class="keyword">extends</span> <span class="title">RouterDelegate</span>&lt;<span class="title">AppPath</span>&gt;  </span></span><br><span class="line"><span class="class">    <span class="title">with</span> <span class="title">ChangeNotifier</span>, <span class="title">PopNavigatorRouterDelegateMixin</span>&lt;<span class="title">AppPath</span>&gt; </span>&#123;  </span><br><span class="line">  <span class="meta">@override</span>  </span><br><span class="line">  <span class="keyword">final</span> GlobalKey&lt;NavigatorState&gt; navigatorKey = GlobalKey&lt;NavigatorState&gt;();  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">final</span> ValueNotifier&lt;AppPath&gt; appState;  </span><br><span class="line">  </span><br><span class="line">  AppRouterDelegate(<span class="keyword">this</span>.appState) &#123;  </span><br><span class="line">    appState.addListener(notifyListeners);  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@override</span>  </span><br><span class="line">  AppPath? <span class="keyword">get</span> currentConfiguration =&gt; appState.value;  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@override</span>  </span><br><span class="line">  Widget build(BuildContext context) &#123;  </span><br><span class="line">    <span class="keyword">final</span> path = appState.value;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">final</span> pages = &lt;Page&gt;[  </span><br><span class="line">      <span class="keyword">if</span> (path.isLogin)  </span><br><span class="line">        <span class="keyword">const</span> MaterialPage(key: ValueKey(<span class="string">&#x27;LoginPage&#x27;</span>), child: LoginPage())  </span><br><span class="line">      <span class="keyword">else</span>  </span><br><span class="line">        <span class="keyword">const</span> MaterialPage(key: ValueKey(<span class="string">&#x27;HomePage&#x27;</span>), child: HomePage()),  </span><br><span class="line">      <span class="keyword">if</span> (path.isDetailPage)  </span><br><span class="line">        MaterialPage(  </span><br><span class="line">          key: ValueKey(<span class="string">&#x27;Detail-<span class="subst">$&#123;path.detailId&#125;</span>&#x27;</span>),  </span><br><span class="line">          child: DetailPage(id: path.detailId!),  </span><br><span class="line">        ),  </span><br><span class="line">    ];  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> Navigator(  </span><br><span class="line">      key: navigatorKey,  </span><br><span class="line">      pages: pages,  </span><br><span class="line">  </span><br><span class="line">      onDidRemovePage: (page) &#123;  </span><br><span class="line">        debugPrint(<span class="string">&#x27;Page removed: <span class="subst">$&#123;page.key&#125;</span>&#x27;</span>);  </span><br><span class="line">        <span class="comment">// 根据被移除的页面类型更新状态  </span></span><br><span class="line">        <span class="keyword">if</span> (path.isDetailPage || path.isLogin) &#123;  </span><br><span class="line">          appState.value = <span class="keyword">const</span> AppPath.home();  </span><br><span class="line">        &#125;  </span><br><span class="line">      &#125;,  </span><br><span class="line">    );  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@override</span>  </span><br><span class="line">  Future&lt;<span class="keyword">void</span>&gt; setNewRoutePath(AppPath configuration) <span class="keyword">async</span> &#123;  </span><br><span class="line">    appState.value = configuration;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@override</span>  </span><br><span class="line">  <span class="keyword">void</span> dispose() &#123;  </span><br><span class="line">    appState.removeListener(notifyListeners);  </span><br><span class="line">    <span class="keyword">super</span>.dispose();  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>lib&#x2F;pages&#x2F;home_page.dart</strong></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;../models/app_path.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomePage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;  </span><br><span class="line">  <span class="keyword">const</span> HomePage(&#123;<span class="keyword">super</span>.key&#125;);  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@override</span>  </span><br><span class="line">  Widget build(BuildContext context) &#123;  </span><br><span class="line">    <span class="keyword">final</span> delegate = Router.of(context).routerDelegate <span class="keyword">as</span> <span class="built_in">dynamic</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> Scaffold(  </span><br><span class="line">      appBar: AppBar(title: <span class="keyword">const</span> Text(<span class="string">&#x27;🏠 Home&#x27;</span>)),  </span><br><span class="line">      body: Center(  </span><br><span class="line">        child: Column(  </span><br><span class="line">          mainAxisAlignment: MainAxisAlignment.center,  </span><br><span class="line">          children: [  </span><br><span class="line">            ElevatedButton(  </span><br><span class="line">              onPressed: () =&gt; delegate.appState.value = <span class="keyword">const</span> AppPath.detail(<span class="string">&#x27;42&#x27;</span>),  </span><br><span class="line">              child: <span class="keyword">const</span> Text(<span class="string">&#x27;进入详情页 /detail/42&#x27;</span>),  </span><br><span class="line">            ),  </span><br><span class="line">            ElevatedButton(  </span><br><span class="line">              onPressed: () =&gt; delegate.appState.value = <span class="keyword">const</span> AppPath.login(),  </span><br><span class="line">              child: <span class="keyword">const</span> Text(<span class="string">&#x27;退出登录 /login&#x27;</span>),  </span><br><span class="line">            ),  </span><br><span class="line">          ],  </span><br><span class="line">        ),  </span><br><span class="line">      ),  </span><br><span class="line">    );  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>lib&#x2F;pages&#x2F;detail_page.dart</strong></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;../models/app_path.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DetailPage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;  </span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> id;  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> DetailPage(&#123;<span class="keyword">super</span>.key, <span class="keyword">required</span> <span class="keyword">this</span>.id&#125;);  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@override</span>  </span><br><span class="line">  Widget build(BuildContext context) &#123;  </span><br><span class="line">    <span class="keyword">final</span> delegate = Router.of(context).routerDelegate <span class="keyword">as</span> <span class="built_in">dynamic</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> Scaffold(  </span><br><span class="line">      appBar: AppBar(title: Text(<span class="string">&#x27;📄 Detail <span class="subst">$id</span>&#x27;</span>)),  </span><br><span class="line">      body: Center(  </span><br><span class="line">        child: ElevatedButton(  </span><br><span class="line">          onPressed: () =&gt; delegate.appState.value = <span class="keyword">const</span> AppPath.home(),  </span><br><span class="line">          child: <span class="keyword">const</span> Text(<span class="string">&#x27;返回主页&#x27;</span>),  </span><br><span class="line">        ),  </span><br><span class="line">      ),  </span><br><span class="line">    );  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>lib&#x2F;pages&#x2F;login_page.dart</strong></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;../models/app_path.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginPage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;  </span><br><span class="line">  <span class="keyword">const</span> LoginPage(&#123;<span class="keyword">super</span>.key&#125;);  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@override</span>  </span><br><span class="line">  Widget build(BuildContext context) &#123;  </span><br><span class="line">    <span class="keyword">final</span> delegate = Router.of(context).routerDelegate <span class="keyword">as</span> <span class="built_in">dynamic</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> Scaffold(  </span><br><span class="line">      appBar: AppBar(title: <span class="keyword">const</span> Text(<span class="string">&#x27;🔐 Login&#x27;</span>)),  </span><br><span class="line">      body: Center(  </span><br><span class="line">        child: ElevatedButton(  </span><br><span class="line">          onPressed: () &#123;  </span><br><span class="line">            <span class="comment">// 模拟登录成功  </span></span><br><span class="line">            delegate.appState.value = <span class="keyword">const</span> AppPath.home();  </span><br><span class="line">          &#125;,  </span><br><span class="line">          child: <span class="keyword">const</span> Text(<span class="string">&#x27;登录成功 → 返回首页&#x27;</span>),  </span><br><span class="line">        ),  </span><br><span class="line">      ),  </span><br><span class="line">    );  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-总结"><a href="#7-总结" class="headerlink" title="7. 总结"></a>7. 总结</h2><p>声明式导航的核心思想是：<strong>“页面不是被命令打开的，而是由状态自然生成的。”</strong><br>当应用状态发生变化（如用户登录、订单提交、或从外部链接唤起），RouterDelegate 会根据当前状态重建页面栈，使 UI 与数据保持同步。这意味着导航逻辑从“操作视图”变为“描述状态”，让代码更直观、更易维护。</p>
<p>其次，随着多导航栈、模态弹窗、深度链接等复杂场景的出现，Navigator 2.0 提供了一种可扩展的“统一建模”方式。无论是移动端、Web 还是桌面端，路由都可以通过 RouteInformationParser 与 RouterDelegate 共同驱动，实现状态、URL、页面栈三者的精确同步。</p>
<p>最后，声明式路由让调试与测试成为可能。我们可以直接验证“给定状态 → 构建页面栈”的正确性，而不再依赖手动点击或 push 流程。这使得导航逻辑正式进入工程化、可预测、可测试的时代。</p>
<blockquote>
<p><strong>一句话总结：Navigator 2.0 不只是新 API，而是让「导航」真正成为「应用状态」的一部分。</strong></p>
</blockquote>
<p>在此基础上，我们还可以继续探索更高层的封装，如 <strong>go_router</strong>、<strong>beamer</strong> 等，它们在 Navigator 2.0 的基础上实现了更强大的路由守卫、模块化注册和动画过渡机制。而在更大型的工程中，还可以尝试构建 <strong>“动态路由中心”</strong> —— 让每个功能模块自注册路由，进一步解耦与扩展应用架构。</p>
<h2 id="8-备注"><a href="#8-备注" class="headerlink" title="8. 备注"></a>8. 备注</h2><p>环境：</p>
<ul>
<li>mac: 15.2</li>
<li>fluttter: 3.35.4</li>
</ul>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.flutter.dev/">https://docs.flutter.dev/</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>KeyChan
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://www.keychan.xyz/2025/10/08/033-flutter-routing-navigation-multi-terminal-collaboration/" title="「Flutter系列④」路由、导航与多端协同：嵌套路由与多端差异处理">https://www.keychan.xyz/2025/10/08/033-flutter-routing-navigation-multi-terminal-collaboration/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="followme">
  <span>欢迎关注我的其它发布渠道</span>

  <div class="social-list">

      <div class="social-item">
          <a target="_blank" class="social-link" href="https://x.com/keychankc">
            <span class="icon">
              <i class="fab fa-twitter"></i>
            </span>

            <span class="label">Twitter</span>
          </a>
      </div>
  </div>
</div>

          <div class="post-tags">
              <a href="/tags/Flutter/" rel="tag"># Flutter</a>
              <a href="/tags/%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/" rel="tag"># 状态管理</a>
              <a href="/tags/%E8%B7%AF%E7%94%B1/" rel="tag"># 路由</a>
              <a href="/tags/%E6%A8%A1%E5%9D%97%E5%8C%96/" rel="tag"># 模块化</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/10/04/032-flutter-state-management-project-architecture/" rel="prev" title="「Flutter系列③」状态管理与项目架构：模块化、DI与可维护性实践">
                  <i class="fa fa-angle-left"></i> 「Flutter系列③」状态管理与项目架构：模块化、DI与可维护性实践
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/10/12/034-flutter-performance-analysis/" rel="next" title="「Flutter系列⑤」性能剖析：帧、内存、启动与并发优化">
                  「Flutter系列⑤」性能剖析：帧、内存、启动与并发优化 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="waline"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">KeyChan</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">260k</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/keychankc" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script size="300" alpha="0.6" zIndex="-1" src="/js/ribbon.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/ribbon.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.4.0/mermaid.min.js","integrity":"sha256-G8ouPAnw4zzMbnAenHnVz6h9XpKbNdOkrqTh7AadyHs="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://comment.mengyajia.com","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":false,"pageview":false,"placeholder":"欢迎评论~","emoji":["https://unpkg.com/@waline/emojis@1.1.0/qq"],"requiredMeta":["nick","mail"],"el":"#waline","comment":true,"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","path":"/2025/10/08/033-flutter-routing-navigation-multi-terminal-collaboration/"}</script>
<link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css">
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script>

</body>
</html>
